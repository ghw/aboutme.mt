<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>18.14. 文件系统快照</title><link rel="stylesheet" type="text/css" href="docbook.css" /><link rev="made" href="doc@FreeBSD.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="FreeBSD 使用手册" /><link rel="up" href="disks.html" title="Chapter 18. 存储" /><link rel="prev" href="disks-virtual.html" title="18.13. 网络、内存和 和以及映像文件为介质的虚拟文件系统" /><link rel="next" href="quotas.html" title="18.15. 文件系统配额" /><link rel="copyright" href="legalnotice.html" title="版权声明" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">18.14. 文件系统快照</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="disks-virtual.html">Prev</a> </td><th width="60%" align="center">Chapter 18. 存储</th><td width="20%" align="right"> <a accesskey="n" href="quotas.html">Next</a></td></tr></table><hr /></div><div class="sect1"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both"><a id="snapshots"></a>18.14. 文件系统快照</h2></div><div><span class="authorgroup">Contributed by <span xmlns="http://www.w3.org/1999/xhtml" class="author"><span class="firstname">Tom</span> <span class="surname">Rhodes</span></span>. </span></div></div></div><a id="idp80484560" class="indexterm"></a><p>FreeBSD 提供了一个和 <a class="link" href="configtuning-disk.html#soft-updates" title="12.12.2. Soft Updates">Soft Updates</a>
	关联的新功能: 文件系统快照</p><p>快照允许用户创建指定文件系统的映像，并把它们当做一个文件来对待。
	快照文件必须在文件系统正在使用时创建，一个用户对每个文件系统创建的
	快照不能大于20个。活动的快照文件被记录在超级块中，所以它们可以在系统
	启动的时候一块进行挂接后摘掉。当一个快照不再需要时，可以使用标准的
	 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=rm&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">rm</span>(1)</span></a> 使用来使其删除。快照可以以任何顺序进行移除，但所有使用
	的快照不可能同时进行移除，因为其它的快照将有可能互相引用一些块。</p><p>不可改的 <code class="option">snapshot</code> 文件标志，
      是由 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mksnap_ffs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mksnap_ffs</span>(8)</span></a> 在完成创建快照文件时设置的。
	<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=unlink&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">unlink</span>(1)</span></a> 命令是一个特例， 以允许删除快照文件。</p><p>快照可以通过 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> 命令创建。 将文件系统
	 <code class="filename">/var</code> 的快照放到
	<code class="filename">/var/snapshot/snap</code> 可以使用下面的命令：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mount -u -o snapshot /var/snapshot/snap /var</code></strong></pre><p>作为选择，你也可以使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mksnap_ffs&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mksnap_ffs</span>(8)</span></a> 来创建一个快照：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mksnap_ffs /var /var/snapshot/snap</code></strong></pre><p>可以查找文件系统中的快照文件 (例如 <code class="filename">/var</code>)，
        方法是使用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=find&amp;sektion=1"><span class="citerefentry"><span class="refentrytitle">find</span>(1)</span></a> 命令：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>find /var -flags snapshot</code></strong></pre><p>当快照文件被创建好后，可以用于下面一些目的：</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>有些管理员用文件快照来进行备份，
	    因为快照可以被转移到 CD 或磁带上。</p></li><li class="listitem"><p>文件系统一致性检查程序 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a> 可以用来检查快照文件。
	    如果文件系统在挂接前是一致的， 则检查结果也一定是一致的
	    (也就是不会做任何修改)。 实际上这也正是后台 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=fsck&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">fsck</span>(8)</span></a>
	    的操作过程。</p></li><li class="listitem"><p>在快照上运行 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a> 程序。
	    dump 将返回包含文件系统和快照的时间戳。<a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=dump&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">dump</span>(8)</span></a>
	    也能够抓取快照，使用 <code class="option">-L</code>
	    标志可以首先创建快照， 完成 dump 映像之后再自动删除它。</p></li><li class="listitem"><p>用 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> 来挂接快照作为文件系统的一个冻结的镜像。
	    要 <a class="citerefentry" href="http://www.FreeBSD.org/cgi/man.cgi?query=mount&amp;sektion=8"><span class="citerefentry"><span class="refentrytitle">mount</span>(8)</span></a> 快照
	    <code class="filename">/var/snapshot/snap</code> 运行：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>mdconfig -a -t vnode -f /var/snapshot/snap -u 4</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mount -r /dev/md4 /mnt</code></strong></pre></li></ul></div><p>现在你就可以看到挂接在 <code class="filename">/mnt</code> 目录下的 <code class="filename">/var</code>
	文件系统的快照。 每一样东西都保存的像它创建时的状态一样。
	唯一例外的是更早的快照文件将表现为长度为 0 的文件。
	用完快照文件之后可以把它卸下，使用：</p><pre class="screen"><code class="prompt">#</code> <strong class="userinput"><code>umount /mnt</code></strong>
<code class="prompt">#</code> <strong class="userinput"><code>mdconfig -d -u 4</code></strong></pre><p>想了解更多关于 <code class="option">softupdates</code> 和
	文件系统快照的信息， 包括技术说明， 可以访问
	Marshall Kirk McKusick 的 WWW 站点
	<code class="uri"><a class="uri" href="http://www.mckusick.com/" target="_top">http://www.mckusick.com/</a></code>。</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="disks-virtual.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="disks.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="quotas.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">18.13. 网络、内存和 和以及映像文件为介质的虚拟文件系统 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 18.15. 文件系统配额</td></tr></table></div><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>本文档和其它文档可从这里下载：
    <a href="ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/">ftp://ftp.FreeBSD.org/pub/FreeBSD/doc/</a>.</small></p><p xmlns="http://www.w3.org/TR/xhtml1/transitional" align="center"><small>如果对于FreeBSD有问题，请先阅读
    <a href="http://www.FreeBSD.org/docs.html">文档</a>，如不能解决再联系
    &lt;<a href="mailto:questions@FreeBSD.org">questions@FreeBSD.org</a>&gt;.<br></br>
    关于本文档的问题请发信联系
    &lt;<a href="mailto:doc@FreeBSD.org">doc@FreeBSD.org</a>&gt;.</small></p></body></html>